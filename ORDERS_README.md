# Управление заказами

## Описание

Создан полнофункциональный ресурс для управления заказами в MoonShine админ-панели с возможностью:

- **CRUD операции**: создание, просмотр, редактирование, удаление заказов
- **Мягкое удаление**: заказы не удаляются физически, а помечаются как удаленные
- **Связи со звонками**: каждый заказ может иметь главный звонок и связанные звонки
- **Слияние заказов**: возможность объединить два заказа в один

## Структура заказа

### Поля заказа:
- **Дата и время оформления** (`order_datetime`) - обязательное поле
- **Город** (`city`) - текстовое поле
- **Адрес** (`address`) - текстовое поле для подробного адреса
- **Телефон** (`phone`) - контактный телефон
- **Дополнительная информация** (`additional_info`) - дополнительная информация о заказе
- **Главный звонок** (`main_call_id`) - связь с основным звонком, после которого сформирован заказ

### Связи:
- **Главный звонок** - связь один-к-одному с моделью Call
- **Связанные звонки** - связь многие-ко-многим с моделью Call через промежуточную таблицу `order_calls`

## Файлы

### Модели:
- `app/Models/Order.php` - основная модель заказа с soft delete и связями
- `app/Models/Call.php` - обновлена для поддержки связей с заказами

### Миграции:
- `database/migrations/2025_10_03_215404_update_orders_table_add_fields.php` - добавление полей в таблицу orders
- `database/migrations/2025_10_03_215423_create_order_calls_table.php` - создание промежуточной таблицы

### MoonShine ресурсы:
- `app/MoonShine/Resources/OrderResource.php` - ресурс для управления заказами
- `app/MoonShine/Pages/OrderMergePage.php` - страница для слияния заказов

### Контроллеры:
- `app/Http/Controllers/OrderMergeController.php` - контроллер для слияния заказов

### Сидеры:
- `database/seeders/OrderSeeder.php` - создание тестовых заказов

## Использование

### Доступ к заказам:
1. Войдите в MoonShine админ-панель
2. Перейдите в раздел "Заказы"
3. Используйте стандартные CRUD операции

### Слияние заказов:
1. Откройте заказ для редактирования
2. Используйте метод `mergeWith()` в модели Order
3. Или используйте контроллер `OrderMergeController`

### Пример слияния заказов:
```php
$sourceOrder = Order::find(1);
$targetOrder = Order::find(2);
$sourceOrder->mergeWith($targetOrder);
```

## Особенности

- **Мягкое удаление**: удаленные заказы можно восстановить
- **Автоматическое слияние**: при слиянии заказов пустые поля заполняются данными из второго заказа
- **Связи со звонками**: автоматический перенос связанных звонков при слиянии
- **Валидация**: проверка корректности данных при создании/редактировании

## Тестовые данные

Запустите сидеры для создания тестовых заказов:
```bash
php artisan db:seed
```

Это создаст 3 тестовых заказа с различными данными для демонстрации функционала.
